<!DOCTYPE html>
<html>

<head>
    <title>Expanding Brain Generator</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.css" />
    <link rel="stylesheet" href="https://unpkg.com/purecss@0.6.2/build/pure-min.css">
    <style>
        #title {
            display: none;
        }
        
        .pure-button-disabled {
            color: rgba(0, 0, 0, .4);
            opacity: unset;
        }
        
        .thumbnail {
            width: 100px;
        }
        
        .navigation {
            width: 100%;
        }
        
        .brain-wrapper textarea {
            display: none;
            position: absolute;
            margin-left: 100px;
            height: 50px;
        }
        
        #brains .brain-wrapper:hover textarea {
            display: inline-block;
        }
        
        #brains .brain-wrapper textarea:focus {
            display: inline-block;
        }
        
        #backup {
            text-align: center;
        }
        
        #backup .brain-wrapper {
            display: inline-block;
        }
        
        #canvas {
            width: 120px;
            cursor: zoom-in;
        }
        
        #overlay {
            width: 600px;
            max-width: 100%;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .7);
            text-align: center;
            color: white;
        }
        
        #loading .fa-spinner {
            margin-top: 20%;
        }
        
        .preview {
            box-sizing: border-box;
            border-right: 1px solid black;
            text-align: center;
        }
        
        .preview aside {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, .4);
            cursor: zoom-out;
            opacity: 0;
            height: 0;
            overflow: auto;
            transition: opacity 0.3s linear;
        }
        
        .preview .inner-container {
            overflow: auto;
        }
        
        .main-container .inner-container {
            height: 200px;
            overflow: hidden;
        }
        
        .preview .inner-container,
        .main-container {
            height: 272px;
            border-top: 1px solid black;
            border-bottom: 1px solid black;
        }
        
        .container .inner-container .brain-wrapper {
            height: 50px;
            overflow: hidden;
        }
        
        .controls {
            border-bottom: 1px solid black;
            text-align: center;
        }
        
        @media screen and (min-device-width: 48em) {
            #title {
                display: block;
            }
            body {
                text-align: center;
            }
            .preview .inner-container,
            .main-container {
                min-height: 272px;
                height: 75vh;
            }
            .main-container .inner-container {
                min-height: 200px;
                height: calc(75vh - 72px);
            }
            .container .inner-container .brain-wrapper {
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <article class="pure-g">
        <h1 id="title" class="pure-u-1">Expanding Brain Generator</h1>
        <section class="pure-u-2-5 preview">
            <div class="inner-container">
                <canvas id="canvas" width="600" height="100" onclick="overlayApi.show()"></canvas>
            </div>
            <aside onclick="overlayApi.hide()">
                <canvas id="overlay" width="600" height="100"></canvas>
            </aside>
        </section>
        <section class="pure-u-3-5 container main-container">
            <button class="pure-button control navigation" onclick="scrollApi.scrollElement(this.nextElementSibling, -50)">
                <i class="fa fa-arrow-up"></i>
            </button>
            <div id="brains" class="inner-container pure-form" onwheel="scrollApi.scrollElement(this, 0, event)"></div>
            <button class="pure-button control navigation" onclick="scrollApi.scrollElement(this.previousElementSibling, 50)">
                <i class="fa fa-arrow-down"></i>
            </button>
        </section>
        <section class="pure-u-1 controls">
            <a class="pure-button pure-button-primary" onclick="canvasApi.downloadCanvas(this, 'meme.png')">
                <i class="fa fa-floppy-o"></i>
            </a>
            <label for="center" class="pure-checkbox">
                <a class="pure-button pure-button-primary">
                    <i class="fa fa-align-center"></i>
                    <input id="center" type="checkbox" onchange="canvasApi.redrawBrains()" checked>
                </a>
            </label>
        </section>
        <aside class="pure-u-1 container">
            <div id="backup" class="inner-container"></div>
        </aside>
    </article>
    <aside id="loading">
        <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
        <span class="sr-only">Loading...</span>
        <p>Use drag&amp;drop and fill the textboxes to create your meme!</p>
    </aside>

    <script>
        var canvasApi = (function () {
            var brainsContainer = document.getElementById('brains');
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');

            return {
                redrawBrains() {
                    canvasApi.clearCanvas();
                    canvasApi.drawRecurrently(0, 0);
                },
                drawRecurrently(heightProm, i) {
                    if (i < brainsContainer.children.length) {
                        var child = brainsContainer.children[i];

                        if (heightProm instanceof Promise) {
                            heightProm.then(function (availableHeight) {
                                canvasApi.drawRecurrently(canvasApi.drawRowAtHeight(child, availableHeight), ++i);
                            });
                        } else {
                            canvasApi.drawRecurrently(canvasApi.drawRowAtHeight(child, heightProm), ++i);
                        }
                    } else {
                        heightProm.then(function () {
                            canvasApi.resizeCanvas(canvas.height - 5);
                            ctx.fillStyle = 'rgba(220,220,220,.8)';
                            ctx.font = '15px Arial';
                            ctx.fillText('mat3e.github.io/brains', 10, 20);
                        });
                    }
                },
                drawRowAtHeight(source, y) {
                    var lineHeight = 3;

                    var imageObj = new Image();
                    imageObj.src = source.lastChild.src;

                    var result = new Promise(function (resolve) {
                        imageObj.onload = function () {
                            var ratio = imageObj.height / imageObj.width;
                            var height = 300 * ratio;
                            var linePosY = y + height;
                            canvasApi.resizeCanvas(linePosY + lineHeight + 1);
                            ctx.drawImage(imageObj, 300, y, 300, height);
                            ctx.fillStyle = '#000';
                            ctx.fillRect(0, linePosY, canvas.width, lineHeight);

                            canvasApi.drawCenteredMultilineText(source, y, height);

                            resolve(linePosY + lineHeight);
                        }
                    });

                    return result;
                },
                drawCenteredMultilineText(source, y, availableHeight) {
                    if (source.firstChild && source.firstChild.value) {
                        var textArray = source.firstChild.value.split('\n');
                        var fontSize = 25;
                        var fontType = 'Arial';
                        var centered = document.getElementById('center').checked;
                        ctx.font = fontSize + 'px ' + fontType;

                        var starter = -10;
                        var i = textArray.length / 2;
                        textArray.forEach(function (line) {
                            var x = 10;
                            if (centered) {
                                ctx.textAlign = 'center';
                                x = 150;
                            } else {
                                ctx.textAlign = 'start';
                            }
                            ctx.fillText(line, x, y + availableHeight / 2 - starter - i * fontSize);
                            --i;
                        });
                    }
                },
                resizeCanvas(newSize) {
                    var temp = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    canvas.height = newSize;
                    canvasApi.clearCanvas();
                    ctx.putImageData(temp, 0, 0);
                },
                clearCanvas() {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                },
                downloadCanvas(link, filename) {
                    link.href = document.getElementById('canvas').toDataURL();
                    link.download = filename;
                }
            }
        })();

        var scrollApi = (function () {
            var className = 'pure-button-disabled';

            return {
                scrollElement(element, value, event) {
                    if (event && event.deltaY) {
                        if (event.deltaY > 0) {
                            scrollApi.scrollElement(element, 50);
                        } else {
                            scrollApi.scrollElement(element, -50);
                        }
                    } else {
                        element.scrollTop += value;
                    }

                    scrollApi.verifyScroll(element);
                },
                verifyScroll(element) {
                    if (element.scrollTop === 0) {
                        addElementClass(element.previousElementSibling, className);
                    } else {
                        removeElementClass(element.previousElementSibling, className);
                    }

                    if (isBottom(element)) {
                        addElementClass(element.nextElementSibling, className);
                    } else {
                        removeElementClass(element.nextElementSibling, className);
                    }
                }
            }

            function addElementClass(element, className) {
                var classes = element.className.split(' ');
                var index = classes.indexOf(className);
                if (index === -1) {
                    classes.push(className);
                    element.className = classes.join(' ');
                }
            };
            function removeElementClass(element, className) {
                var classes = element.className.split(' ');
                var index = classes.indexOf(className);
                if (index !== -1) {
                    classes.splice(index, 1);
                    element.className = classes.join(' ');
                }
            };
            function isBottom(element) {
                var diff = element.scrollHeight - element.scrollTop;
                return diff === element.clientHeight || diff <= element.clientHeight + 5; // up to 5 - tolerance for calc
            };
        })();

        var overlayApi = (function () {
            var overlayStyle = document.getElementById('overlay').parentElement.style;

            return {
                show() {
                    var originalCanvas = document.getElementById('canvas');
                    var originalCtx = originalCanvas.getContext('2d');
                    var overlayCanvas = document.getElementById('overlay');
                    var overlayCtx = overlayCanvas.getContext('2d');

                    overlayCanvas.height = originalCanvas.height;
                    overlayCtx.putImageData(originalCtx.getImageData(0, 0, originalCanvas.width, originalCanvas.height), 0, 0);

                    overlayStyle.height = '100%';
                    overlayStyle.opacity = '1';
                },
                hide() {
                    overlayStyle.opacity = '0';
                    overlayStyle.height = '0';
                }
            }
        })();

        (function () {
            window.onload = function () {
                var load = document.getElementById('loading');
                load.parentElement.removeChild(load);
            };

            var BRAIN_START = 0, BRAIN_END = 10;
            var BACKUP_START = 0, BACKUP_END = 14;

            var brainsContainer = document.getElementById('brains');
            generateBrains();
            var backupContainer = document.getElementById('backup');
            generateBackup();

            canvasApi.redrawBrains();
            scrollApi.verifyScroll(brainsContainer);

            var drake = dragula([brainsContainer, backupContainer]);
            drake.on('drop', function (el, target, source) {
                if (source !== target || target === brainsContainer) {
                    canvasApi.redrawBrains();
                    scrollApi.verifyScroll(brainsContainer);
                }
            });

            function generateBrains() {
                generateImgs('img/', BRAIN_START, BRAIN_END, brainsContainer);
            }

            function generateBackup() {
                generateImgs('img/bonus/', BACKUP_START, BACKUP_END, backupContainer);
            }

            function generateImgs(prefix, from, to, parent) {
                for (var i = from; i <= to; ++i) {
                    var div = document.createElement('div');
                    div.id = parent.id + ':' + i;
                    div.className = 'brain-wrapper';

                    var input = document.createElement('textarea');
                    input.onchange = canvasApi.redrawBrains;

                    var image = document.createElement('img');
                    image.src = prefix + i + '.jpg';
                    image.className = 'thumbnail';

                    div.appendChild(input);
                    div.appendChild(image);

                    parent.appendChild(div);
                }
            }
        })();
    </script>
</body>

</html>